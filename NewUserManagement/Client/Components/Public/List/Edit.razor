@page "/list/edit/{UserId:int}"
@using NewUserManagement.Client.Services
@using NewUserManagement.Client.Components
@using NewUserManagement.Shared.Models
@using NewUserManagement.Client.Components.Public
@using Microsoft.JSInterop


<div class="modal @_modalClass" id="informationalModal" tabindex="-1" aria-labelledby="informationalModalLabel" role="dialog" style="display:@_modalDisplay">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Edit User Details</h5>
				<button @onclick="CloseEditModal" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				@if (UserDetails != null)
				{
					<div class="">
						<p><strong>Forename:</strong><InputText @bind-Value="@UserDetails.Forename"> </InputText></p>
						<p><strong>Surname:</strong> <InputText @bind-Value="@UserDetails.Surname"></InputText></p>
						<p><strong>Email:</strong> <InputText @bind-Value="@UserDetails.Email"></InputText></p>
						<p><strong>Date of Birth:</strong><InputDate @bind-Value="@UserDetails.DateOfBirth" format="MM/dd/yyyy"> </InputDate></p>
					</div>
					<div class="d-flex justify-content-end">    <button @onclick="SubmitForm" type="button" class="btn btn-success shadow text-end">Save Changes</button></div>
				}
				else
				{
					<p>Loading user details...</p>
				}
			</div>
			<div class="modal-footer">
				<button @onclick="PreviousUser" type="button" class="btn btn-primary shadow">Previous</button>
				<button @onclick="NextUser" type="button" class="btn btn-primary shadow">Next</button>
				<button @onclick="CloseEditModal" type="button" class="btn btn-primary shadow" data-bs-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>
@if (_showBackdrop == true)
{
	<div class="modal-backdrop fade show"></div>
}
@code {
	@inject InMemoryDatabaseCache DatabaseCache
	@inject NavigationManager NavigationManager
	@inject IJSRuntime JSRuntime


	[Parameter] public int UserId { get; set; }
	private List<User> users = new List<User>();

	private int _selectedUserId { get; set; }
	private User UserDetails { get; set; } = new User(); // Initialize with a default user object
	protected override async Task OnInitializedAsync()
	{
		// Fetch user details based on the UserId parameter
		UserDetails = await DatabaseCache.GetUserDetails(UserId) ?? new User();

	}


	private async void NextUser()
	{
		int index = DatabaseCache.Users.FindIndex(u => u.Id == UserDetails.Id);
		if (index != -1)
		{
			index++; // Move to the next user

			if (index >= DatabaseCache.Users.Count)
			{
				index = 0; // Wrap around to the first user if reached the end
			}
			UserDetails = DatabaseCache.Users[index];
			await updateUrlWithoutNavigation("edit", UserDetails.Id);
		}
	}

	private async void PreviousUser()
	{
		int index = DatabaseCache.Users.FindIndex(u => u.Id == UserDetails.Id);
		if (index != -1)
		{
			index--; // Move to the previous user

			if (index < 0)
			{
				index = DatabaseCache.Users.Count - 1; // Wrap around to the last user if reached the beginning
			}
			UserDetails = DatabaseCache.Users[index];
			await updateUrlWithoutNavigation("edit", UserDetails.Id);
		}
	}
	[Parameter] public EventCallback EditModalClickBtnClose { get; set; }
	private string? _modalDisplay = null;
	private string? _modalClass = null;
	private bool _showBackdrop = false;
	protected override void OnInitialized() => ShowEditModal();

	private async void ShowEditModal()
	{
		_modalDisplay = "block;";
		_modalClass = "show";
		_showBackdrop = true;
		await updateUrlWithoutNavigation("edit", UserId);
	}
	[Parameter] public bool _showingViewModalWindow { get; set; }
	private async Task CloseEditModal()
	{
		_modalDisplay = "none;";
		_modalClass = string.Empty;
		_showBackdrop = false;
		await EditModalClickBtnClose.InvokeAsync();
		NavigationManager.NavigateTo("/list");
	}
	private async Task updateUrlWithoutNavigation(string route, int? UserId)
	{
		string url = $"/list/{route}/{UserId}";
		await JSRuntime.InvokeVoidAsync("updateUrlWithoutNavigation", route, UserId);

	}
	private async Task SubmitForm()
	{
		// Perform validation or other necessary operations
		// Save changes to the user details

		// Close the modal
		await CloseEditModal();
	}

}
